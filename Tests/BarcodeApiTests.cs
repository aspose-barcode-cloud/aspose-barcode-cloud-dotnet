using System.Collections.Generic;
using System.IO;
using System.Linq;
using Aspose.BarCode.Cloud.Sdk.Api;
using Aspose.BarCode.Cloud.Sdk.Interfaces;
using Aspose.BarCode.Cloud.Sdk.Model;
using Aspose.BarCode.Cloud.Sdk.Model.Requests;
using NUnit.Framework;

namespace Aspose.BarCode.Cloud.Sdk.Tests
{
    /// <summary>
    ///     Class for testing BarcodeApi
    /// </summary>
    /// <remarks>
    ///     This file is automatically generated by Swagger Codegen.
    ///     Please update the test case below to test the API endpoint.
    /// </remarks>
    [TestFixture]
    public class BarcodeApiTests : TestsBase
    {
        /// <summary>
        ///     Setup before each unit test
        /// </summary>
        [SetUp]
        public void Init()
        {
            _api = new BarcodeApi(TestConfiguration);
            _fileApi = new FileApi(TestConfiguration);
        }

        /// <summary>
        ///     Clean up after each unit test
        /// </summary>
        [TearDown]
        public void Cleanup()
        {
        }

        private IBarcodeApi _api;
        private IFileApi _fileApi;

        private string PutTestFile(string fileName)
        {
            using FileStream fileToUpload = File.Open(TestFilePath(fileName), FileMode.Open, FileAccess.Read);
            FilesUploadResult uploaded = _fileApi.UploadFile(
                new UploadFileRequest(
                    $"{TempFolderPath}/{fileName}",
                    fileToUpload
                )
            );
            Assert.IsNotEmpty(uploaded.Uploaded);

            return TempFolderPath;
        }


        /// <summary>
        ///     Test GetBarcodeGenerate
        /// </summary>
        [Test]
        public void GetBarcodeGenerateTest()
        {
            // Arrange
            var request = new GetBarcodeGenerateRequest(
                text: "Very sample text",
                type: EncodeBarcodeType.Code128.ToString(),
                format: "png"
            );

            // Act
            using Stream response = _api.GetBarcodeGenerate(request);
            // Assert
            Assert.IsTrue(response.Length > 0);
            using FileStream savedFileStream = File.Create(TestFilePath("Test_GetBarcodeGenerate.png"));
            response.CopyTo(savedFileStream);
        }


        /// <summary>
        ///     Test GetBarcodeRecognize
        /// </summary>
        [Test]
        public void GetBarcodeRecognizeTest()
        {
            // Arrange
            var barcodesToRecognize = new List<GeneratorParams>
            {
                new GeneratorParams
                {
                    TypeOfBarcode = EncodeBarcodeType.QR,
                    Text = "Hello world!"
                },
                new GeneratorParams
                {
                    TypeOfBarcode = EncodeBarcodeType.Code128,
                    Text = "Hello world!"
                }
            };

            const string fileName = "Test_PostGenerateMultiple.png";
            string folder = PutTestFile(fileName);
            var request = new GetBarcodeRecognizeRequest(
                fileName,
                folder: folder,
                preset: PresetType.HighPerformance.ToString()
            );

            // Act
            BarcodeResponseList response = _api.GetBarcodeRecognize(request);

            // Assert
            Assert.AreEqual(barcodesToRecognize.Count, response.Barcodes.Count);

            foreach ((GeneratorParams generated, BarcodeResponse recognized) in
                barcodesToRecognize.Zip(response.Barcodes,
                    (generated, recognized) => (generated, recognized)))
            {
                Assert.AreEqual(generated.TypeOfBarcode.ToString(), recognized.Type);
                Assert.AreEqual(generated.Text, recognized.BarcodeValue);
            }
        }


        /// <summary>
        ///     Test an instance of BarcodeApi
        /// </summary>
        [Test]
        public void InstanceTest()
        {
            Assert.IsInstanceOf(typeof(IBarcodeApi), _api, "instance is a IBarcodeApi");
        }


        /// <summary>
        ///     Test PostBarcodeRecognizeFromUrlOrContent
        /// </summary>
        [Test]
        public void PostBarcodeRecognizeFromUrlOrContentTest()
        {
            // Arrange
            BarcodeResponseList response;
            using (Stream image = GetTestImage("1.png"))
            {
                var request = new PostBarcodeRecognizeFromUrlOrContentRequest(
                    image: image,
                    checksumValidation: ChecksumValidation.Off.ToString(),
                    preset: PresetType.HighPerformance.ToString()
                );

                // Act
                response = _api.PostBarcodeRecognizeFromUrlOrContent(request);
            }

            // Assert
            Assert.AreEqual(1, response.Barcodes.Count);
            Assert.AreEqual(DecodeBarcodeType.Code11.ToString(), response.Barcodes[0].Type);
            Assert.AreEqual("1234567812", response.Barcodes[0].BarcodeValue);
        }


        /// <summary>
        ///     Test PostGenerateMultiple
        /// </summary>
        [Test]
        public void PostGenerateMultipleTest()
        {
            // Arrange
            var request = new PostGenerateMultipleRequest(
                new GeneratorParamsList
                {
                    BarcodeBuilders = new List<GeneratorParams>
                    {
                        new GeneratorParams
                        {
                            TypeOfBarcode = EncodeBarcodeType.QR,
                            Text = "Hello world!"
                        },
                        new GeneratorParams
                        {
                            TypeOfBarcode = EncodeBarcodeType.Code128,
                            Text = "Hello world!"
                        }
                    }
                }
            );

            // Act
            using Stream response = _api.PostGenerateMultiple(request);
            // Assert

            Assert.IsTrue(response.Length > 0);
            using FileStream savedFileStream = File.Create(TestFilePath("Test_PostGenerateMultiple.png"));
            response.CopyTo(savedFileStream);
        }


        /// <summary>
        ///     Test PutBarcodeGenerateFile
        /// </summary>
        [Test]
        public void PutBarcodeGenerateFileTest()
        {
            // Arrange
            var request = new PutBarcodeGenerateFileRequest(
                "Test_PutBarcodeGenerateFile.png",
                EncodeBarcodeType.Code128.ToString(),
                "Hello!",
                folder: TempFolderPath
            );

            // Act
            ResultImageInfo response = _api.PutBarcodeGenerateFile(request);

            // Assert
            Assert.True(response.FileSize > 0);
            Assert.True(response.ImageWidth > 0);
            Assert.True(response.ImageHeight > 0);
        }


        /// <summary>
        ///     Test PutBarcodeRecognizeFromBody
        /// </summary>
        [Test]
        public void PutBarcodeRecognizeFromBodyTest()
        {
            // Arrange
            var barcodesToRecognize = new List<GeneratorParams>
            {
                new GeneratorParams
                {
                    TypeOfBarcode = EncodeBarcodeType.Code128,
                    Text = "Very sample text"
                }
            };

            const string fileName = "Test_GetBarcodeGenerate.png";
            string folder = PutTestFile(fileName);

            var request = new PutBarcodeRecognizeFromBodyRequest(
                fileName,
                new ReaderParams
                {
                    Preset = PresetType.HighPerformance
                },
                folder: folder
            );

            // Act
            BarcodeResponseList response = _api.PutBarcodeRecognizeFromBody(request);

            // Assert
            Assert.AreEqual(barcodesToRecognize.Count, response.Barcodes.Count);

            foreach ((GeneratorParams generated, BarcodeResponse recognized) in
                barcodesToRecognize.Zip(response.Barcodes,
                    (generated, recognized) => (generated, recognized)))
            {
                Assert.AreEqual(generated.TypeOfBarcode.ToString(), recognized.Type);
                Assert.AreEqual(generated.Text, recognized.BarcodeValue);
            }
        }


        /// <summary>
        ///     Test PutGenerateMultiple
        /// </summary>
        [Test]
        public void PutGenerateMultipleTest()
        {
            // Arrange
            var generatorParamsList = new GeneratorParamsList
            {
                BarcodeBuilders = new List<GeneratorParams>
                {
                    new GeneratorParams
                    {
                        TypeOfBarcode = EncodeBarcodeType.Code128,
                        Text = "Hello world!"
                    }
                }
            };

            var request = new PutGenerateMultipleRequest(
                "Test_PutGenerateMultiple.png",
                generatorParamsList,
                folder: TempFolderPath
            );

            // Act
            ResultImageInfo response = _api.PutGenerateMultiple(request);

            // Assert
            Assert.True(response.FileSize > 0);
            Assert.True(response.ImageWidth > 0);
            Assert.True(response.ImageHeight > 0);
        }
    }
}
